<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.min.js" integrity="sha384-QJHtvGhmr9XOIpI6YVutG+2QOK9T+ZnN4kzFN1RtK3zEFEIsxhlmWl5/YESvpZ13" crossorigin="anonymous"></script>
    <script type="text/javascript" src="//patrila.app:5001/assets/js/streamify.js"></script>
    <title>Client</title>
</head>
<body allowfullscreen="true" webkitallowfullscreen="true" mozallowfullscreen="true">



    <div id="app"></div>

    <script type="text/javascript" src="//patrila.app:5000/socket.io/socket.io.js"></script>

    <script type="module">
        import {render,Component,Template,$_GET,uuidv4} from '/js/adarna.js';
        import {ArrowPadsComponent} from '/components/ArrowPadsComponent.js'; 

        const app = document.querySelector('#app');
        

     

    
        let view = new class extends Component{

            init(){

                this.rover_name = trim($_GET('r'));

                if(!this.rover_name){
                    alert('Target bot not defined, please select again');
                    document.location.href = '/';
                    return false;
                }

                this.lastCommand;
                this.broadcast;
                this.commandDelay       = 1000;
                this.roverName          = null;
                this.peerConnection     = null;
                this.broker             = null;
                this.initConnection();
                this.initStream();
            }


            view(){
                const t = new Template();
                let ArrowPads = new ArrowPadsComponent();

                return t.div({},()=>{

                    t.div({dataEl:'modal', class:'modal',tabindex:'-1'},()=>{
                        t.div({class:'modal-dialog'},()=>{
                            t.div({class:'modal-content'},()=>{
                                t.div({class:'modal-header'},()=>{
                                    t.h5({class:'modal-title'},'Tourtron');
                                });

                                t.div({class:'modal-body'},()=>{
                                    t.txt('Receive stream');
                                });

                                t.div({class:'modal-footer'},()=>{
                        
                                    t.button({
                                        type:'button',
                                        class:'btn btn-primary',
                                        dataEl:'receiveStreamBtn'
                                    },'Ok');

                                });//div
                            });//div
                        });//div
                    });

                    t.div({class:'row'},()=>{
                        
                        t.div({class:'col text-center'},()=>{

                           // t.div({class:'embed-responsive embed-responsive-16by9'},()=>{

                                t.video({
                                    style:{
                                      minWidth: '100%',
                                      maxHeight: '100%'
                                    },
                                    playsinline:true, 
                                    autoplay:true, 
                                    muted:true,
                                    controls:true,
                                    poster:'https://via.placeholder.com/300.jpg?text=TEST',
                                    //src:'https://www.w3schools.com/html/mov_bbb.mp4',
                                    dataEl:'video'
                                });


                                t.div({
                                    style:{
                                        position: 'fixed',
                                        bottom: 0,
                                        width: '100%',
                                        padding: '20px'
                                    }
                                },()=>{
                                    t.div({class:'d-flex justify-content-between'},()=>{
                                        
                                        t.button({class:'control-buttons mt-auto', dataEl:'fullScreenBtn'},()=>{
                                            t.img({src:'/assets/img/maximize.png'});
                                        });
                                        
                                        t.el(ArrowPads.component.bindTo(this).as('directionPad')); 
                                    });
                                });
                           // });//div
                        
                        });//div
                      
                    });//div
                });
            }


            controller(){

                this.modalReceiveStream = new bootstrap.Modal(this.el.modal,{});
                
                this.el.directionPad.handler.onchange((command,time,id)=>{
                    
                    switch(command){
                        case 'UP':
                            this.moveForward();
                            break;
                        
                        case 'DOWN':
                            this.moveBackward();
                            break;

                        case 'LEFT':
                            this.rotateLeft();
                            break;

                        case 'RIGHT':
                            this.rotateRight();
                            break;

                        case 'NEUTRAL':
                            this.allStop();
                            break;
                        
                        default: 
                            this.allStop(time,id);    

                    }
                });


               

               this.el.fullScreenBtn.onclick = ()=>{
                    this.toggleFullScreen();

                    if (document.fullscreenElement != null) {
                        this.el.fullScreenBtn.firstChild.src = '/assets/img/maximize.png';
                    } else {
                        this.el.fullScreenBtn.firstChild.src = '/assets/img/minimize.png';         
                    }
               }

               
               
               this.el.receiveStreamBtn.onclick = ()=>{
                    this.el.video.play();
                    this.modalReceiveStream.hide();      
               }

               
            }

            toggleFullScreen(){
                let doc     = window.document;
                let docEl   = doc.documentElement;

                let requestFullScreen =
                    docEl.requestFullscreen ||
                    docEl.mozRequestFullScreen ||
                    docEl.webkitRequestFullScreen ||
                    docEl.msRequestFullscreen;
                let cancelFullScreen =
                    doc.exitFullscreen ||
                    doc.mozCancelFullScreen ||
                    doc.webkitExitFullscreen ||
                    doc.msExitFullscreen;

                if (
                    !doc.fullscreenElement &&
                    !doc.mozFullScreenElement &&
                    !doc.webkitFullscreenElement &&
                    !doc.msFullscreenElement
                ) {
                    requestFullScreen.call(docEl);
                } else {
                    cancelFullScreen.call(doc);
                }
            }

            moveForward(){
                this.sendCommand('forward');
            }

            moveBackward(){
                this.sendCommand('backward');
            }

            rotateLeft(){
                this.sendCommand('rotate-left');
            }

            rotateRight(){
                this.sendCommand('rotate-right');
            }

            allStop(){
                this.sendCommand('stop');
            }

            sendCommand(command,time,id){
                console.log(command);
                
                clearInterval(this.lastCommand);

                if(!this.broker) return false;

                this.broker.volatile.emit(command,this.roverName);
                
                this.lastCommand = setInterval(()=>{
                   this.broker.volatile.emit(command,this.roverName);
                },this.commandDelay);
                
            }

            initConnection(){

                //Connect to broker
                this.broker = io("wss://patrila.app:5000/",{
                    reconnection:false
                });

              //  this.broker.emit('get-available-rovers',(list)=>{
                
                setTimeout(()=>{

                    this.broker.emit('connect-to-rover',{
                        name: this.rover_name,
                        uid: uuidv4()
                    });

                },1000);
                  
                //});
                
                let webRTCconfig = {
                    iceServers: [
                        { 
                        "urls": "stun:stun.l.google.com:19302",
                        },
                        { 
                            "urls": "turn:turn.patrila.app:5349",
                            "username": "guest",
                            "credential": "somepassword"
                        }
                    ]
                };


                this.broker.on("offer", (id, description, name) => {
        
                    this.peerConnection = new RTCPeerConnection(webRTCconfig);
                    
                    this.peerConnection
                        .setRemoteDescription(description)
                        .then(()  => this.peerConnection.createAnswer())
                        .then(sdp => this.peerConnection.setLocalDescription(sdp))
                        .then(() => {                        
                            this.broker.emit("answer", id, this.peerConnection.localDescription);
                        }).catch((e)=>{
                            console.log('error',e);
                        });


                    this.peerConnection.ontrack = event => {

                        this.el.video.srcObject = event.streams[0];
                        this.broker.volatile.emit('connection-success',name);
                        this.roverName = name;

                        if(!this.el.video.classList.contains('show')){
                            this.modalReceiveStream.show();
                        }
                
                    };

                    this.peerConnection.onicecandidate = event => {
                        if (event.candidate) {
                            this.broker.emit("candidate", id, event.candidate);
                        }
                    };

                });


                this.broker.on("candidate", (id, candidate) => {
                    this.peerConnection
                        .addIceCandidate(new RTCIceCandidate(candidate))
                        .catch(e => console.error(e));
                });

                //If rover is disconnected then close the peer connection
                this.broker.on('rover-disconnected',()=>{
                    if(this.peerConnection){
                        this.peerConnection.close();
                        this.peerConnection = null;
                    }
                });

                //If rover failed to broadcast
                this.broker.on('rover-broadcast-failed',(message)=>{

                    if(this.peerConnection){
                        this.peerConnection.close();
                        this.peerConnection = null
                    }

                    console.log('Error: '+message);
                });

            }

            initStream(){

                this.broker.on('request-client-stream',(clientScoketId)=>{

                    getMediaCaptureDevices().then(media=>{
                    
                        broadcastStream({
                            camera: media.video[0].id,
                            microphone: media.audio[0].id,
                            socket:this.broker,
                            clientSocketId: clientScoketId,
                            state:{name:''}
                        }).then((bcast)=>{

                            this.broadcast = bcast;
                            console.log('done');

                        }).catch(err=>{
                            
                            
                            this.broker.volatile.emit(
                                'client-broadcast-failed',
                                 clientScoketId,
                                'Client cannot connect to rover'
                            );

                            console.log('Error',err);
                        });

                    }).catch(err=>{

                        this.broker.volatile.emit(
                            'client-broadcast-failed',
                            clientScoketId,
                            'Camera or Microphone not accessible'
                        );
                        console.log('ERROR',err);
                    });
                });
               
            }

            style(){
                return {
                    '.control-buttons':{
                        height:'50px',
                        width:'50px',
                        backgroundColor:'rgba(0,0,0,0.2)',
                        borderRadius:'50%'
                    },
                    '.control-buttons img':{
                        height:'25px',
                        width:'25px'
                    }
                }
            }

        }();



        render(view).to(app);


              /***************************************************************/

       /**
        const forward   = document.querySelector('#forward');
        const backward  = document.querySelector('#backward');
        const left      = document.querySelector('#left');
        const right     = document.querySelector('#right');
        
        
        let lastCommand;
        let commandDelay = 2000;

        //Forward
        forward.onmousedown = ()=>{
            console.log('forward');
            clearInterval(lastCommand);
            broker.volatile.emit('forward',roverName);
            lastCommand = setInterval(()=>{
                broker.volatile.emit('forward',roverName);
            },commandDelay);
               
        }

        forward.onmouseout = ()=>{
            clearInterval(lastCommand);
            broker.volatile.emit('stop',roverName);
        }

        forward.onmouseup = ()=>{

            clearInterval(lastCommand);
            broker.volatile.emit('stop',roverName);
        }

        //Backward
        backward.onmousedown = ()=>{
            console.log('backward');
            clearInterval(lastCommand);
            broker.volatile.emit('backward',roverName);
            lastCommand = setInterval(()=>{
                broker.volatile.emit('backward',roverName);
            },commandDelay);
            
        }

        backward.onmouseout = ()=>{
            clearInterval(lastCommand);
            broker.volatile.emit('stop',roverName);
        }

        backward.onmouseup = ()=>{
            clearInterval(lastCommand);
            broker.volatile.emit('stop',roverName);
        }

        //Left
        left.onmousedown = ()=>{
            console.log('left');
            clearInterval(lastCommand);
            broker.volatile.emit('rotate-left',roverName);
            lastCommand = setInterval(()=>{
                broker.volatile.emit('rotate-left',roverName);
            },commandDelay);
        }

        left.onmouseout = ()=>{
            clearInterval(lastCommand);
            broker.volatile.emit('stop',roverName);
        }

        left.onmouseup = ()=>{
            clearInterval(lastCommand);
            broker.volatile.emit('stop',roverName);
        }

        //Right
        right.onmousedown = ()=>{
            console.log('right');
            clearInterval(lastCommand);
            broker.volatile.emit('rotate-right',roverName);
            lastCommand = setInterval(()=>{
                broker.volatile.emit('rotate-right',roverName);
            },commandDelay);
            
        }

        right.onmouseout = ()=>{
            clearInterval(lastCommand);
            broker.volatile.emit('stop',roverName);
        }

        right.onmouseup = ()=>{
            clearInterval(lastCommand);
            broker.volatile.emit('stop',roverName);
        }

    **/
    </script>
   
</body>
</html>