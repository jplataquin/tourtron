<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.min.js" integrity="sha384-QJHtvGhmr9XOIpI6YVutG+2QOK9T+ZnN4kzFN1RtK3zEFEIsxhlmWl5/YESvpZ13" crossorigin="anonymous"></script>
    <title>Client</title>
</head>
<body>
    <video id="videoEl" playsinline autoplay muted></video>


    <table>
        <tr>
            <td></td>
            <td>
                <button id="forward">ðŸ •</button>
            </td>
            <td></td>
        </tr>
        <tr>
            <td><button id="left">ðŸ ”</button></td>
            <td><button id="backward">ðŸ —</button></td>
            <td><button id="right">ðŸ –</button></td>
        </tr>
    </table>

    <div id="app"></div>

    <script type="text/javascript" src="//patrila.app:5000/socket.io/socket.io.js"></script>

    <script type="module">
        import {render,Component,Template} from '/js/adarna.js';
        import {ArrowPadsComponent} from '/components/ArrowPadsComponent.js'; 

        const app = document.querySelector('#app');

       

        let view = new class extends Component{

            view(){
                const t = new Template();
                let ArrowPads = new ArrowPadsComponent();
                return t.div({},()=>{
                    t.div({class:'row'},()=>{
                        
                        t.div({class:'col text-center'},()=>{

                            t.div({class:'embed-responsive embed-responsive-16by9'},()=>{

                                t.video({
                                    class:'embed-responsive-item',
                                    src:'https://www.w3schools.com/html/mov_bbb.mp4'
                                });
                            });//div
                        
                        });//div
                      
                    });//div
                });
            }

        }();



        render(view).to(app);

        let roverName       = null;
        let peerConnection  = null;
        let videoEl         = document.querySelector('#videoEl');

        //Connect to broker
        const broker = io("wss://patrila.app:5000/",{
            reconnection:false
        });

        broker.emit('get-available-rovers',(list)=>{
            console.log(list);

            broker.emit('connect-to-rover',{
                name:'TOURTRON_1',
                uid:1
            });
        });
        
        

        let webRTCconfig = {
            iceServers: [
                { 
                "urls": "stun:stun.l.google.com:19302",
                },
                { 
                    "urls": "turn:turn.patrila.app:5349",
                    "username": "user",
                    "credential": "somepassword"
                }
            ]
        };


        broker.on("offer", (id, description, name) => {
  
            peerConnection = new RTCPeerConnection(webRTCconfig);
            
            peerConnection
                .setRemoteDescription(description)
                .then(()  => peerConnection.createAnswer())
                .then(sdp => peerConnection.setLocalDescription(sdp))
                .then(() => {
                    broker.emit("answer", id, peerConnection.localDescription);
                });


            peerConnection.ontrack = event => {
                videoEl.srcObject = event.streams[0];
                broker.volatile.emit('connection-success',name);
                roverName = name;
            };

            peerConnection.onicecandidate = event => {
                if (event.candidate) {
                    broker.emit("candidate", id, event.candidate);
                }
            };

        });


        broker.on("candidate", (id, candidate) => {
            peerConnection
                .addIceCandidate(new RTCIceCandidate(candidate))
                .catch(e => console.error(e));
        });

        //If rover is disconnected then close the peer connection
        broker.on('rover-disconnected',()=>{
            if(peerConnection){
                peerConnection.close();
                peerConnection = null;
            }
        });

        //If rover failed to broadcast
        broker.on('rover-broadcast-failed',(message)=>{

            if(peerConnection){
                peerConnection.close();
                peerConnection = null
            }

            console.log('Error: '+message);
        });
        /***************************************************************/

       
        const forward   = document.querySelector('#forward');
        const backward  = document.querySelector('#backward');
        const left      = document.querySelector('#left');
        const right     = document.querySelector('#right');
        
 
        let lastCommand;
        let commandDelay = 2000;

        //Forward
        forward.onmousedown = ()=>{
            console.log('forward');
            clearInterval(lastCommand);
            broker.volatile.emit('forward',roverName);
            lastCommand = setInterval(()=>{
                broker.volatile.emit('forward',roverName);
            },commandDelay);
               
        }

        forward.onmouseout = ()=>{
            clearInterval(lastCommand);
            broker.volatile.emit('stop',roverName);
        }

        forward.onmouseup = ()=>{

            clearInterval(lastCommand);
            broker.volatile.emit('stop',roverName);
        }

        //Backward
        backward.onmousedown = ()=>{
            console.log('backward');
            clearInterval(lastCommand);
            broker.volatile.emit('backward',roverName);
            lastCommand = setInterval(()=>{
                broker.volatile.emit('backward',roverName);
            },commandDelay);
            
        }

        backward.onmouseout = ()=>{
            clearInterval(lastCommand);
            broker.volatile.emit('stop',roverName);
        }

        backward.onmouseup = ()=>{
            clearInterval(lastCommand);
            broker.volatile.emit('stop',roverName);
        }

        //Left
        left.onmousedown = ()=>{
            console.log('left');
            clearInterval(lastCommand);
            broker.volatile.emit('rotate-left',roverName);
            lastCommand = setInterval(()=>{
                broker.volatile.emit('rotate-left',roverName);
            },commandDelay);
        }

        left.onmouseout = ()=>{
            clearInterval(lastCommand);
            broker.volatile.emit('stop',roverName);
        }

        left.onmouseup = ()=>{
            clearInterval(lastCommand);
            broker.volatile.emit('stop',roverName);
        }

        //Right
        right.onmousedown = ()=>{
            console.log('right');
            clearInterval(lastCommand);
            broker.volatile.emit('rotate-right',roverName);
            lastCommand = setInterval(()=>{
                broker.volatile.emit('rotate-right',roverName);
            },commandDelay);
            
        }

        right.onmouseout = ()=>{
            clearInterval(lastCommand);
            broker.volatile.emit('stop',roverName);
        }

        right.onmouseup = ()=>{
            clearInterval(lastCommand);
            broker.volatile.emit('stop',roverName);
        }


    </script>
   
</body>
</html>