<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rover</title>
</head>
<body>
    <h1>Hello World</h1>
    
    <table>
        <tr>
            <td></td>
            <td>
                <button id="forward">ðŸ •</button>
            </td>
            <td></td>
        </tr>
        <tr>
            <td><button id="left">ðŸ ”</button></td>
            <td><button id="backward">ðŸ —</button></td>
            <td><button id="right">ðŸ –</button></td>
        </tr>
    </table>

    <!--
    <script type="text/javascript" src="http://localhost:3000/socket.io/socket.io.js"></script>
    -->

    <script type="text/javascript" src="//patrila.app:5000/socket.io/socket.io.js"></script>
    <script type="text/javascript" src="//patrila.app:5001/assets/js/streamify.js"></script>

    <script>
        
        const broker = io("wss://patrila.app:5000/");

        let state = {
            name:'TOURTRON_1',
            status:'ready'
        };

        broker.on('connect',()=>{

         
            setInterval(()=>{

                if(state.status == 'ready'){
                    broker.emit('status',state);
                }

            },3000);
        
        });
       
        
        //status update
        broker.on('status',(data)=>{
            console.log('status',data);
            state = data;
        });


        broker.on('connection-request',(data)=>{
            console.log('connection-request',data);

            //Update rover state to pending request
            state = data.state;

            getMediaCaptureDevices().then(media=>{
               console.log(media);
                broadcastStream({
                    camera: media.video[0].id,
                    microphone: media.audio[0].id,
                    socket:broker,
                    clientId:data.clientId,
                    state:state
                }).then(()=>{
                    console.log('done');
                })
            });
        });
      
    </script>

    <script type="module">
        /*
        const forward   = document.querySelector('#forward');
        const backward  = document.querySelector('#backward');
        const left      = document.querySelector('#left');
        const right     = document.querySelector('#right');
        
        
        const socket = io("ws://localhost:3000/");
        
        let lastCommand;

        //Forward
        forward.onmousedown = ()=>{

            clearInterval(lastCommand);
            socket.emit('forward');
            lastCommand = setInterval(()=>{
                socket.emit('forward');
            },2000);
               
        }

        forward.onmouseout = ()=>{
            clearInterval(lastCommand);
            socket.emit('stop');
        }

        forward.onmouseup = ()=>{

            clearInterval(lastCommand);
            socket.emit('stop');
        }

        //Backward
        backward.onmousedown = ()=>{

            clearInterval(lastCommand);
            socket.emit('backward');
            lastCommand = setInterval(()=>{
                socket.emit('backward');
            },2000);
            
        }

        backward.onmouseout = ()=>{
            clearInterval(lastCommand);
            socket.emit('stop');
        }

        backward.onmouseup = ()=>{
            clearInterval(lastCommand);
            socket.emit('stop');
        }

        //Left
        left.onmousedown = ()=>{

            clearInterval(lastCommand);
            socket.emit('rotate-left');
            lastCommand = setInterval(()=>{
                socket.emit('rotate-left');
            },2000);
        }

        left.onmouseout = ()=>{
            clearInterval(lastCommand);
            socket.emit('stop');
        }

        left.onmouseup = ()=>{
            clearInterval(lastCommand);
            socket.emit('stop');
        }

        //Right
        right.onmousedown = ()=>{

            clearInterval(lastCommand);
            socket.emit('rotate-right');
            lastCommand = setInterval(()=>{
                socket.emit('rotate-right');
            },2000);
            
        }

        right.onmouseout = ()=>{
            clearInterval(lastCommand);
            socket.emit('stop');
        }

        right.onmouseup = ()=>{
            clearInterval(lastCommand);
            socket.emit('stop');
        }**/


    </script>
</body>
</html>