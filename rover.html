<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.min.js" integrity="sha384-QJHtvGhmr9XOIpI6YVutG+2QOK9T+ZnN4kzFN1RtK3zEFEIsxhlmWl5/YESvpZ13" crossorigin="anonymous"></script>
    
    <title>Rover</title>

</head>
<body>
    <div id="app"></div>
   
    <script type="text/javascript" src="//patrila.app:5000/socket.io/socket.io.js"></script>
    <script type="text/javascript" src="//patrila.app:5001/assets/js/streamify.js"></script>

    <script type="module">
        import {render,Component,Template} from '/js/adarna.js';
        import videoSizeStablizer from '/assets/js/videoSizeStablizer.js';

        const statusDisplay = document.getElementById('status');
        

        const app = document.querySelector('#app');
        
    
        let view = new class extends Component{

            init(){

                this.state = {
                    name:'TOURTRON_1',
                    status:'ready',
                    time:(new Date).getTime()
                };
                this.local;
                this.broker;
                this.peerConnection;
                this.lastCommnand   = '';
                this.broadcast      = null;
                this.clientID       = null;
               //this.initLocalSocket();
                this.initBrokerSocket();
                this.commands();
                this.receiveStream();
            }

            view(){

                const t = new Template();

                return t.div({},()=>{

                    t.div({
                        class:'container d-flex align-items-center justify-content-center',
                        style:{
                            height:window.innerHeight+'px'
                        }
                    },()=>{

                        t.div({class:'embed-responsive embed-responsive-16by9'},()=>{
               
                            t.video({
                                style:{
                                    minHeight: '100%',
                                    maxWidth:'100%'
                                },
                                playsinline:true, 
                                autoplay:true, 
                                muted:true,
                                controls:true,
                                poster:'https://via.placeholder.com/300.jpg?text=TEST',
                                //src:'https://www.w3schools.com/html/mov_bbb.mp4',
                                dataEl:'video'
                            });
                        
                            
                        });//div
                    });
                    
                });
            }

            controller(){

                videoSizeStablizer(this.el.video);
            }

            initLocalSocket(){
                
                this.local  = io('ws://localhost:3000');
                
                this.local.on('connect',()=>{
                    console.log('Local server connected');
                });

                this.local.on('disconnected',()=>{
                    
                    //Stop the stream
                    if(this.broadcast != null){
                        this.broadcast.stopStream();
                    }

                    this.updateState({
                        status:'ready',
                        time:(new Date()).getTime()
                    });

                    if(this.broker){
                        this.broker.volatile.emit('rover-not-responding');
                    }
                    
                });
            }


            initBrokerSocket(){
              
                this.broker = io("wss://patrila.app:5000");
                  
                this.broker.on('connect',()=>{

                    let pendingFlag = false;

                    setInterval(()=>{

                        let now = (new Date()).getTime();
                        
                        //If state is ready inform broker
                        if(this.state.status == 'ready'){
                            pendingFlag = false;
                            this.broker.volatile.emit('status',this.state);
                        }

                        //If pending status has not change in more or equal to 10 seconds
                        if(this.state.status == 'pending' && (now - this.state.time) >= 10000 && !pendingFlag){

                            pendingFlag = true;

                            //Stop the stream
                            if(this.broadcast != null){
                                this.broadcast.stopStream();
                            }
                            
                            this.updateState({
                                status:'ready',
                                time:(new Date()).getTime()
                            });

                            this.broker.volatile.emit('rover-not-responding');
                            
                            //Stop movement
                            if(this.local){
                                this.local.emit('stop');
                            }
                        }
                        
                    },2000);
                
                });
            
                
                //If there is a status update
                this.broker.on('status',(data)=>{
                    this.updateState({
                        status:data.status,
                        time:(new Date()).getTime()
                    });
                });


                //If a client wants to connect
                this.broker.on('connection-request',(data)=>{
                    
                    //Update rover state to pending
                    this.updateState({
                        status:'pending',   
                        time:(new Date()).getTime()
                    });

                    getMediaCaptureDevices().then(media=>{
                    
                        broadcastStream({
                            camera: media.video[0].id,
                            microphone: media.audio[0].id,
                            socket: this.broker,
                            clientSocketId: data.clientId,
                            state:this.state
                        }).then((bcast)=>{

                            this.broadcast = bcast;
                            
                            //Request stream of client
                            this.broker.emit('request-client-stream',data.clientId);

                            this.clientID = data.clientId;

                            this.ping();

                        }).catch(err=>{
                            
                            updateState({
                                status:'ready',
                                time:(new Date()).getTime()
                            });

                            this.broker.volatile.emit(
                                'rover-broadcast-failed',
                                this.state.name,
                                data.clientId,
                                'Rover cannot connect to client'
                            );

                            
                            if(this.local){
                                this.local.emit('stop');
                            }
                            
                            console.log('Error',err);
                        });

                    }).catch(err=>{

                        updateState({
                            status:'ready',
                            time:(new Date()).getTime()
                        });
                        
                        this.broker.volatile.emit(
                            'rover-broadcast-failed',
                            this.state.name,
                            data.clientId,
                            'Cannot access camera or microphone'
                        );
                        
                        if(this.local){
                            this.local.emit('stop');
                        }
                        console.log('ERROR',err);
                    });
                });

                //if client got disconnected
                this.broker.on('client-disconnected',()=>{
                    
                    console.log('Client disconneced');
                    
                    //Stop the stream
                    if(this.broadcast != null){
                        console.log('boradcast',broadcast);
                        this.broadcast.stopStream();
                    }
                    
                    //Stop movement
                    if(this.local){
                        this.local.emit('stop');
                    }

                    this.updateState({
                        status:'ready',
                        time:(new Date()).getTime()
                    });
                    

                    if(this.peerConnection){
                        this.peerConnection.close();
                        this.peerConnection = null;
                    }
                });
            }

            updateState(data){

                for(let key in this.state){
                    if(typeof data[key] != 'undefined'){
                        this.state[key] = data[key];
                    } 
                }
            }

            commands(){
                //local
                let timeoutCommand;
                
                let localDelay = 2000;
        
                this.broker.on('forward',()=>{
                    
                    //if(lastCommnand == 'forward') return false;
                    //lastCommand = 'forward';

                    clearInterval(timeoutCommand);
                    
                    this.local.volatile.emit('forward');
                    
                    statusDisplay.innerHTML = 'FORWARD';

                    timeoutCommand = setTimeout(()=>{
                        this.local.volatile.emit('stop');
                    },localDelay);
                    
                });

                this.broker.on('backward',()=>{

                    //if(lastCommnand == 'backward') return false;
                    //lastCommand = 'backward';
                    
                    clearInterval(timeoutCommand);
                    
                    this.local.volatile.emit('backward');

                    statusDisplay.innerHTML = 'BACKWARD';
                    
                    
                    timeoutCommand = setTimeout(()=>{
                        this.local.volatile.emit('stop');
                    },localDelay);
                    
                });

                this.broker.on('rotate-left',()=>{

                    //if(lastCommnand == 'rotate-left') return false;
                    //lastCommand = 'rotate-left';
                    
                    //clearInterval(lastCommand);
                    
                    this.local.volatile.emit('rotate-left');

                    statusDisplay.innerHTML = 'ROTATE LEFT';
                    
                    timeoutCommand = setTimeout(()=>{
                        this.local.volatile.emit('stop');
                    },localDelay);
                    
                });

                this.broker.on('rotate-right',()=>{

                // if(lastCommnand == 'rotate-right') return false;
                    //lastCommand = 'rotate-right';
                    
                    //clearInterval(lastCommand);
                    
                    this.local.volatile.emit('rotate-right');

                    statusDisplay.innerHTML = 'ROTATE RIGHT';
                    
                    timeoutCommand = setTimeout(()=>{
                        this.local.volatile.emit('stop');
                    },localDelay);
                    
                });

                this.broker.on('stop',()=>{

                    //if(lastCommnand == 'stop') return false;
                    //lastCommand = 'stop';
                    

                    //clearInterval(lastCommand);
                    
                    this.local.volatile.emit('stop');

                    statusDisplay.innerHTML = 'STOP';
                    
                    timeoutCommand = setTimeout(()=>{
                        this.local.volatile.emit('stop');
                    },localDelay);
                    
                });

            }
        
            receiveStream(){
                
                let webRTCconfig = {
                    iceServers: [
                        { 
                        "urls": "stun:stun.l.google.com:19302",
                        },
                        { 
                            "urls": "turn:turn.patrila.app:5349",
                            "username": "guest",
                            "credential": "somepassword"
                        }
                    ]
                };


                this.broker.on("offer", (id, description, name) => {
        
                    this.peerConnection = new RTCPeerConnection(webRTCconfig);
                    
                    this.peerConnection
                        .setRemoteDescription(description)
                        .then(()  => this.peerConnection.createAnswer())
                        .then(sdp => this.peerConnection.setLocalDescription(sdp))
                        .then(() => {
                        
                            this.broker.emit("answer", id, this.peerConnection.localDescription);

                        }).catch((e)=>{
                            console.log('error',e);
                        });


                    this.peerConnection.ontrack = event => {
                        this.el.video.srcObject = event.streams[0];    
                    };

                    this.peerConnection.onicecandidate = event => {
                        if (event.candidate) {    
                            this.broker.emit("candidate", id, event.candidate);
                        }
                    };

                });


                this.broker.on("candidate", (id, candidate) => {
                    
                    if(this.peerConnection){
                        this.peerConnection
                        .addIceCandidate(new RTCIceCandidate(candidate))
                        .catch(e => console.error(e));
                    }
                });

                this.broker.on('client-broadcast-failed',(message)=>{

                    if(this.peerConnection){
                        this.peerConnection.close();
                        this.peerConnection = null
                    }

                    console.log('Error: '+message);
                });
            }

            ping(){

                setInterval(()=>{
                    let now = (new Date).getTime();
                    
                    if(this.clientID){
                        console.log('here');
                        this.broker.emit('xping',{
                            id: this.clientID,
                            time:now
                        });
                    }
                    
                },5000);

                //Handle ping
                this.broker.on('xping',(data)=>{

                    console.log('rcv',data);

                });
                
            }
        }();

        render(view).to(app);

        
      

        
        


    </script>



   
</body>
</html>